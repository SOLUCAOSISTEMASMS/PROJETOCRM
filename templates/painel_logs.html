{% extends "base.html" %}
{% block conteudo %}

<h1 class="mb-4">
  <i class="bi bi-shield-lock" style="font-size: 1.6rem;"></i>
  <span style="font-size: 1.8rem;">Auditoria</span>
</h1>

<!-- üîç Filtros -->
<form method="get" class="row g-2 mb-3">
  <div class="col-md-3">
    <input type="date" name="data_inicio" class="form-control" value="{{ request.args.get('data_inicio', '') }}">
  </div>
  <div class="col-md-3">
    <input type="date" name="data_fim" class="form-control" value="{{ request.args.get('data_fim', '') }}">
  </div>
  <div class="col-md-3">
    <input type="text" name="termo" class="form-control" placeholder="Buscar nos detalhes..." value="{{ termo }}">
  </div>
  <div class="col-md-3">
    <select name="acao" class="form-select">
      <option value="">Todas as a√ß√µes</option>
      {% for item in acoes %}
        <option value="{{ item }}" {% if item == acao %}selected{% endif %}>{{ item }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-12">
    <button type="submit" class="btn btn-primary w-100">Filtrar</button>
  </div>
</form>


<!-- üìÑ Tabela de logs -->
<div class="table-responsive">
  <table class="table table-bordered table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th scope="col"><i class="bi bi-calendar3"></i> Data/Hora</th>
    <th scope="col"><i class="bi bi-person"></i> Usu√°rio</th>
    <th scope="col"><i class="bi bi-gear"></i> A√ß√£o</th>
    <th scope="col"><i class="bi bi-file-text"></i> Detalhes</th>
    <th scope="col"><i class="bi bi-globe"></i> IP</th>
    <th scope="col"><i class="bi bi-compass"></i> Navegador</th>

      </tr>
    </thead>
    <tbody>
      {% for log in logs.items %}
      <tr>
        <td>{{ log.data_hora.strftime('%d/%m/%Y %H:%M:%S') }}</td>
        <td>{{ log.usuario.nome }}</td>
        {% set acao_lower = log.acao|lower %}
        <td class="log-acao">
          {% if "excluiu" in acao_lower %}
            <i class="bi bi-trash3 text-danger"></i>
          {% elif "editou" in acao_lower %}
            <i class="bi bi-pencil-square text-primary"></i>
          {% elif "criou" in acao_lower %}
            <i class="bi bi-plus-circle text-success"></i>
          {% elif "atualizou" in acao_lower %}
            <i class="bi bi-arrow-repeat text-warning"></i>
          {% else %}
            <i class="bi bi-info-circle text-secondary"></i>
          {% endif %}
          {{ log.acao }}
        </td>
        <td>{{ log.detalhes }}</td>
        <td>{{ log.ip }}</td>
        <td>{{ log.user_agent[:80] }}{% if log.user_agent|length > 80 %}...{% endif %}</td>
      </tr>
      {% else %}
      <tr><td colspan="6" class="text-center">Nenhum log encontrado.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- üîÑ Pagina√ß√£o -->
<nav>
  <ul class="pagination justify-content-center">
    {% if logs.has_prev %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('painel_logs', pagina=logs.prev_num, termo=termo, acao=acao) }}">&laquo;</a>
    </li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
    {% endif %}

    <li class="page-item active"><span class="page-link">{{ logs.page }}</span></li>

    {% if logs.has_next %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('painel_logs', pagina=logs.next_num, termo=termo, acao=acao) }}">&raquo;</a>
    </li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
    {% endif %}
  </ul>
</nav>

{% endblock %}