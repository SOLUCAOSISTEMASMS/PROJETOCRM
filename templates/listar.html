{% extends 'base.html' %}
{% block titulo %}Lista de Leads{% endblock %}
{% block conteudo %}

<div class="container-fluid mt-4">

  <!-- üîç Filtro de busca -->
  <form method="GET" action="{{ url_for('listar') }}" class="row g-2 mb-3 align-items-end">
    <div class="col-md-5">
      <input type="text" name="busca" class="form-control" placeholder="Buscar por cliente, origem ou status" value="{{ request.args.get('busca', '') }}">
    </div>
    <div class="col-md-auto">
      <button type="submit" class="btn btn-outline-primary">
        <i class="bi bi-search"></i> Buscar
      </button>
    </div>
    <div class="col-md-auto ms-auto">
      <a href="{{ url_for('criar_lead', cliente_id='') }}" class="btn btn-primary">
  <i class="bi bi-person-plus-fill"></i> Novo Lead
</a>

    </div>
  </form>

  <!-- üìã T√≠tulo -->
  <h3 class="d-flex align-items-center mb-2" style="font-weight: 600; font-size: 1.75rem;">
    <span class="badge text-white me-2" style="background-color: #d87474; font-size: 1.4rem;">
      <i class="bi bi-person-lines-fill"></i>
    </span>
    Lista de Leads
  </h3>

  <!-- üîÑ Filtro por status -->
  <div class="d-flex align-items-center justify-content-between mb-4 flex-wrap gap-2">
    <form method="GET" action="{{ url_for('listar') }}" class="mb-0">
      <select name="status" class="form-select form-select-sm w-auto" onchange="this.form.submit()">
        <option value="">Todos os Status</option>
        {% for s in ['Novo', 'Em contato', 'Convertido', 'Perdido'] %}
          <option value="{{ s }}" {% if status == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </form>
  </div>

  <!-- üìã Tabela de leads -->
  {% if leads %}
    <div class="table-responsive shadow-sm">
      <table id="tabela-leads" class="table table-striped table-hover align-middle table-theme-verde-menta">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Origem</th>
            <th>Status</th>
            <th>Data Retorno</th>
            <th>Data de Cadastro</th>
            <th><i class="bi bi-person-fill"></i> Respons√°vel</th>
            <th class="text-center">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% for lead in leads %}
            <tr>
              <td>{{ lead.cliente.nome }}</td>
              <td>{{ lead.origem }}</td>
              <td>
                <span class="badge
                  {% if lead.status == 'Convertido' %}bg-success
                  {% elif lead.status == 'Perdido' %}bg-danger
                  {% elif lead.status == 'Em contato' %}bg-warning
                  {% else %}bg-secondary{% endif %}
                ">
                  {{ lead.status }}
                </span>
              </td>
              <td>
                {% if lead.data_retorno %}
    {{ lead.data_retorno.strftime('%d/%m/%Y') }}
    {% if lead.data_retorno == current_date %}
      <span class="ms-1 text-warning" title="Retorno marcado para hoje">
        <i class="bi bi-exclamation-triangle-fill"></i>
      </span>
    {% endif %}
  {% else %}
    <span class="text-muted">Sem retorno agendado</span>
  {% endif %}

              </td>
              <td>
                {% if lead.data_cadastro %}
                  <span class="badge bg-info text-dark">{{ lead.data_cadastro.strftime('%d/%m/%Y') }}</span>
                {% else %}
                  <span class="text-muted">‚Äî</span>
                {% endif %}
              </td>
              <td>
                {% set cor_map = {'admin': 'danger', 'gerente': 'primary', 'vendedor': 'warning'} %}
                {% set cor = cor_map.get(lead.criado_por.tipo, 'success') %}
                <span class="badge bg-info text-dark border border-info">
  <i class="bi bi-person-fill"></i>
  {% if lead.criado_por_id == current_user.id %}
    Voc√™
  {% else %}
    {{ lead.criado_por.nome_usuario }}
  {% endif %}
</span>
              </td>
              <td class="text-center">
                <a href="{{ url_for('editar_lead', id=lead.id) }}" class="btn btn-sm btn-warning me-1">
                  <i class="bi bi-pencil"></i>Editar
                </a>
                <a href="{{ url_for('detalhes_lead', lead_id=lead.id) }}" class="btn btn-sm btn-info me-1">
                  <i class="bi bi-eye-fill"></i>Detalhes
                </a>
                <form action="{{ url_for('excluir_lead', lead_id=lead.id) }}" method="POST" style="display:inline;">
                  <button type="button" class="btn btn-sm btn-danger" onclick="confirmarExclusao('{{ url_for('excluir_lead', lead_id=lead.id) }}')">
                    <i class="bi bi-trash"></i>Excluir
                  </button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-warning text-center">Nenhum lead cadastrado ainda.</div>
  {% endif %}
</div>

<!-- üìä Gr√°fico por origem -->
{% if origens and totais %}
  <div class="card shadow-sm border-0 mt-5">
    <div class="card-header bg-success bg-gradient text-white d-flex align-items-center">
      <i class="bi bi-graph-up me-2 fs-5"></i>
      <h5 class="mb-0">Distribui√ß√£o por Origem dos Leads</h5>
    </div>
    <div class="card-body text-center">
      <canvas id="graficoOrigem" height="100" style="max-width:450px; width:100%; margin:auto;"></canvas>
    </div>
  </div>
{% else %}
  <div class="alert alert-info text-center mt-3">
    Nenhum dado dispon√≠vel para o gr√°fico de origem dos leads.
  </div>
{% endif %}

<!-- üì¶ Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  $(document).ready(function () {
    // üìã Inicializa√ß√£o da DataTable
    $('#tabela-leads').DataTable({
      order: [[4, 'desc']],
      searching: false,
      language: {
        url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
      },
      columnDefs: [{ targets: [6], orderable: false }]
    });

    // üìä Gr√°fico por origem
    const origens = {{ origens | default([]) | tojson | safe }};
    const totais = {{ totais | default([]) | tojson | safe }};
    const labelsComTotais = origens.map((origem, i) => `${origem}: ${totais[i]}`);
    const canvas = document.getElementById('graficoOrigem');
    if (canvas) {
      const ctx = canvas.getContext('2d');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labelsComTotais,
          datasets: [{
            data: totais,
            backgroundColor: [
              '#4CAF50', '#2196F3', '#FFC107', '#E91E63',
              '#9C27B0', '#FF5722', '#00BCD4', '#607D8B'
            ],
            borderColor: '#ffffff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                boxWidth: 20,
                font: { size: 14 }
              }
            },
            title: {
              display: true,
              text: 'Gr√°fico por Origem dos Leads',
              font: { size: 16 }
            }
          }
        }
      });
    }
  });

  // üóëÔ∏è Confirma√ß√£o de exclus√£o
  function confirmarExclusao(url) {
    Swal.fire({
      title: 'Tem certeza?',
      text: 'Esta a√ß√£o vai excluir o lead permanentemente.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Sim, excluir',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        const form = document.createElement('form');
        form.action = url;
        form.method = 'POST';
        document.body.appendChild(form);
        form.submit();
      }
    });
  }
</script>

<!-- ‚úÖ Mensagens SweetAlert -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      {% if message == 'lead_atualizado' and category == 'success' %}
        <script>
          Swal.fire({
            icon: 'success',
            title: 'Altera√ß√µes salvas!',
            text: 'O lead foi atualizado com sucesso.',
            confirmButtonColor: '#3085d6',
            confirmButtonText: 'OK'
          });
        </script>
      {% elif message == 'retorno_hoje' and category == 'warning' %}
        <script>
          Swal.fire({
            title: 'Aten√ß√£o!',
            text: 'Voc√™ tem leads com data de retorno marcada para hoje.',
            icon: 'warning',
            confirmButtonColor: '#d33',
            confirmButtonText: 'OK'
          });
        </script>
      {% else %}
        <script>
          Swal.fire({
            title: 'Conclu√≠do!',
            text: '{{ message }}',
            icon: '{{ category }}',
            confirmButtonColor: '#3085d6',
            confirmButtonText: 'OK'
          });
        </script>
      {% endif %}
    {% endfor %}
  {% endif %}
{% endwith %}
{% endblock %}