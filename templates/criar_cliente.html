{% extends "base.html" %}
{% block conteudo %}
<div class="container mt-4">

  <h3><i class="bi bi-person-plus-fill"></i> Cadastrar Novo Cliente</h3>

  <ul class="nav nav-tabs mt-3" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="tab" href="#dados">Dados do Cliente</a>
    </li>
    <li class="nav-item">
      <a class="nav-link disabled" href="#">Contatos</a>
    </li>
  </ul>

  <div class="tab-content border p-4 rounded-bottom">
    <div class="tab-pane fade show active" id="dados">

      <form method="POST" action="{{ url_for('criar_cliente') }}">
        {{ form.hidden_tag() }}

        {% for field in form %}
          {% for error in field.errors %}
            <div class="alert alert-danger">{{ error }}</div>
          {% endfor %}
        {% endfor %}

        <div class="row">
          <div class="col-md-2 mb-3">
            <label for="codigo">Código</label>
            <input type="text" class="form-control text-center" id="codigo" name="codigo"
                   value="{{ cliente.codigo if cliente else '' }}" readonly>
          </div>
          <div class="col-md-6 mb-3">
            <label for="nome">Nome</label>
            {{ form.nome(class="form-control", id="nome") }}
          </div>
          <div class="col-md-4 mb-3">
            <label for="cpf_cnpj">CPF ou CNPJ</label>
           <input type="text" id="cpf_cnpj" name="cpf_cnpj" class="form-control" placeholder="Digite CPF ou CNPJ">
          </div>
        </div>

        <div class="mb-3">
          <label for="empresa">Empresa</label>
          {{ form.empresa(class="form-control", id="empresa") }}
        </div>

        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="telefone">Telefone</label>
            {{ form.telefone(class="form-control", id="telefone") }}
          </div>
          <div class="col-md-4 mb-3">
            <label for="email">Email</label>
            {{ form.email(class="form-control", id="email") }}
          </div>
        </div>

        <h5 class="mt-4">Endereço</h5>
        <div class="row g-2">
          <div class="col-md-4">
            {{ form.rmcep(class="form-control", id="rmcep", placeholder="CEP") }}
          </div>
          <div class="col-md-8">
            {{ form.endereco_rua(class="form-control", id="endereco_rua", placeholder="Rua") }}
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-md-4">
            {{ form.endereco_numero(class="form-control", id="endereco_numero", placeholder="Número") }}
          </div>
          <div class="col-md-4">
            {{ form.endereco_complemento(class="form-control", id="endereco_complemento", placeholder="Complemento") }}
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-md-4">
            {{ form.bairro(class="form-control", id="bairro", placeholder="Bairro") }}
          </div>
          <div class="col-md-4">
            {{ form.cidade(class="form-control", id="cidade", placeholder="Cidade") }}
          </div>
          <div class="col-md-4">
            {{ form.estado(class="form-control", id="estado", placeholder="UF") }}
          </div>
        </div>

        <div class="text-end mt-4">
          <a href="{{ url_for('listar_clientes') }}" class="btn btn-outline-secondary me-2">Voltar</a>
          <button type="submit" class="btn btn-outline-primary">
            <i class="bi bi-check-circle-fill"></i> Salvar
          </button>
        </div>
      </form>

    </div>
  </div>
</div>

<!-- Scripts essenciais -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function () {
  const $cpfCnpj = $('#cpf_cnpj');

  let mascaraAtual = '';

  function definirMascara(valor) {
    const digitos = valor.replace(/\D/g, '');
    const novaMascara = digitos.length <= 11 ? '000.000.000-00' : '00.000.000/0000-00';

    // só aplica se a máscara mudou
    if (mascaraAtual !== novaMascara) {
      $cpfCnpj.mask(novaMascara);
      mascaraAtual = novaMascara;
    }
  }

  // Consulta CNPJ ao perder o foco
  $cpfCnpj.on('blur', function () {
  const raw = $(this).val().replace(/\D/g, '');

  console.log("Disparou blur com:", raw); // Debug

  // Aplica a máscara correta
  const novaMascara = raw.length <= 11 ? '000.000.000-00' : '00.000.000/0000-00';
  $cpfCnpj.unmask();
  $cpfCnpj.mask(novaMascara, { reverse: true });

  // Consulta CNPJ se houver 14 dígitos
  if (raw.length >= 14) {
    fetch(`https://publica.cnpj.ws/cnpj/${raw}`)
      .then(response => response.json())
      .then(data => {
        const e = data.estabelecimento;
        if (data.razao_social && e) {
          $("#empresa").val(data.razao_social || "");
          $("#endereco_rua").val(e.logradouro || "");
          $("#endereco_numero").val(e.numero || "");
          $("#endereco_complemento").val(e.complemento || "");
          $("#bairro").val(e.bairro || "");
          $("#cidade").val(e.cidade?.nome || "");
          $("#estado").val(e.estado?.sigla || "");
          $("#rmcep").val(e.cep || "");
        } else {
          Swal.fire({
            icon: "warning",
            title: "CNPJ não encontrado",
            text: "Verifique o número digitado.",
            confirmButtonColor: "#f8af00"
          });
        }
      })
      .catch(() => {
        Swal.fire({
          icon: "error",
          title: "Erro na consulta de CNPJ",
          text: "Não foi possível acessar os dados.",
          confirmButtonColor: "#d33"
        });
      });
  }
});


  // Consulta CEP ao perder foco
  $('#rmcep').on('blur', function () {
    const cep = $(this).val().replace(/\D/g, '');
    if (cep.length === 8) {
      fetch(`https://viacep.com.br/ws/${cep}/json/`)
        .then(response => response.json())
        .then(data => {
          if (!("erro" in data)) {
            $("#endereco_rua").val(data.logradouro || "");
            $("#bairro").val(data.bairro || "");
            $("#cidade").val(data.localidade || "");
            $("#estado").val(data.uf || "");
            $("#endereco_numero").focus();
          } else {
            Swal.fire({
              icon: "error",
              title: "CEP não encontrado",
              text: "Verifique o número digitado.",
              confirmButtonColor: "#d33"
            });
          }
        });
    }
  });
});
</script>

{% endblock %}